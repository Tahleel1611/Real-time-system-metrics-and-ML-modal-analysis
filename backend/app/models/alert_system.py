"""\nAlert and notification system for real-time monitoring.\n\nThis module provides a comprehensive alert system that monitors system metrics\nand ML model outputs, triggering notifications when thresholds are exceeded.\n"""\n\nimport logging\nfrom datetime import datetime\nfrom typing import Dict, List, Any, Optional\nfrom enum import Enum\nimport json\n\n\nclass AlertSeverity(Enum):\n    """Alert severity levels"""\n    INFO = "info"\n    WARNING = "warning"\n    CRITICAL = "critical"\n\n\nclass AlertType(Enum):\n    """Types of alerts"""\n    CPU_HIGH = "cpu_high"\n    MEMORY_HIGH = "memory_high"\n    DISK_HIGH = "disk_high"\n    NETWORK_ANOMALY = "network_anomaly"\n    ML_ANOMALY_DETECTED = "ml_anomaly_detected"\n    PROCESS_HIGH_USAGE = "process_high_usage"\n\n\nclass Alert:\n    """Represents a single alert"""\n    \n    def __init__(\n        self,\n        alert_type: AlertType,\n        severity: AlertSeverity,\n        message: str,\n        metric_value: float,\n        threshold: float,\n        timestamp: Optional[datetime] = None\n    ):\n        self.alert_type = alert_type\n        self.severity = severity\n        self.message = message\n        self.metric_value = metric_value\n        self.threshold = threshold\n        self.timestamp = timestamp or datetime.now()\n        self.id = f"{alert_type.value}_{self.timestamp.timestamp()}"\n    \n    def to_dict(self) -> Dict[str, Any]:\n        """Convert alert to dictionary format"""\n        return {\n            'id': self.id,\n            'type': self.alert_type.value,\n            'severity': self.severity.value,\n            'message': self.message,\n            'metric_value': self.metric_value,\n            'threshold': self.threshold,\n            'timestamp': self.timestamp.isoformat()\n        }\n\n\nclass AlertManager:\n    """Manages alert generation and storage"""\n    \n    def __init__(self):\n        self.alerts: List[Alert] = []\n        self.max_alerts = 100  # Keep last 100 alerts\n        self.logger = logging.getLogger(__name__)\n        \n        # Default thresholds\n        self.thresholds = {\n            'cpu_percent': 85.0,\n            'memory_percent': 90.0,\n            'disk_percent': 95.0,\n            'network_anomaly_score': 0.8\n        }\n    \n    def set_threshold(self, metric: str, value: float) -> None:\n        """\n        Set custom threshold for a metric.\n        \n        Args:\n            metric: Metric name (e.g., 'cpu_percent')\n            value: Threshold value\n        """\n        self.thresholds[metric] = value\n        self.logger.info(f"Threshold for {metric} set to {value}")\n    \n    def check_metrics(self, metrics: Dict[str, Any]) -> List[Alert]:\n        """\n        Check system metrics against thresholds and generate alerts.\n        \n        Args:\n            metrics: Dictionary containing system metrics\n        \n        Returns:\n            List of generated alerts\n        """\n        new_alerts = []\n        \n        # Check CPU\n        if 'cpu' in metrics and 'percent' in metrics['cpu']:\n            cpu_percent = metrics['cpu']['percent']\n            if cpu_percent >= self.thresholds['cpu_percent']:\n                alert = Alert(\n                    alert_type=AlertType.CPU_HIGH,\n                    severity=AlertSeverity.CRITICAL if cpu_percent >= 95 else AlertSeverity.WARNING,\n                    message=f"CPU usage is high: {cpu_percent:.1f}%",\n                    metric_value=cpu_percent,\n                    threshold=self.thresholds['cpu_percent']\n                )\n                new_alerts.append(alert)\n        \n        # Check Memory\n        if 'memory' in metrics and 'percent' in metrics['memory']:\n            memory_percent = metrics['memory']['percent']\n            if memory_percent >= self.thresholds['memory_percent']:\n                alert = Alert(\n                    alert_type=AlertType.MEMORY_HIGH,\n                    severity=AlertSeverity.CRITICAL if memory_percent >= 95 else AlertSeverity.WARNING,\n                    message=f"Memory usage is high: {memory_percent:.1f}%",\n                    metric_value=memory_percent,\n                    threshold=self.thresholds['memory_percent']\n                )\n                new_alerts.append(alert)\n        \n        # Check Disk\n        if 'disk' in metrics and 'percent' in metrics['disk']:\n            disk_percent = metrics['disk']['percent']\n            if disk_percent >= self.thresholds['disk_percent']:\n                alert = Alert(\n                    alert_type=AlertType.DISK_HIGH,\n                    severity=AlertSeverity.CRITICAL,\n                    message=f"Disk usage is critical: {disk_percent:.1f}%",\n                    metric_value=disk_percent,\n                    threshold=self.thresholds['disk_percent']\n                )\n                new_alerts.append(alert)\n        \n        # Add alerts to history\n        for alert in new_alerts:\n            self._add_alert(alert)\n        \n        return new_alerts\n    \n    def check_ml_anomalies(self, anomaly_data: Dict[str, Any]) -> List[Alert]:\n        """\n        Check ML anomaly detection results and generate alerts.\n        \n        Args:\n            anomaly_data: Dictionary containing anomaly detection results\n        \n        Returns:\n            List of generated alerts\n        """\n        new_alerts = []\n        \n        if 'anomalies' in anomaly_data:\n            anomalies = anomaly_data['anomalies']\n            if isinstance(anomalies, list) and len(anomalies) > 0:\n                alert = Alert(\n                    alert_type=AlertType.ML_ANOMALY_DETECTED,\n                    severity=AlertSeverity.WARNING,\n                    message=f"Detected {len(anomalies)} anomalies in system behavior",\n                    metric_value=len(anomalies),\n                    threshold=0\n                )\n                new_alerts.append(alert)\n                self._add_alert(alert)\n        \n        return new_alerts\n    \n    def check_processes(self, processes: List[Dict[str, Any]]) -> List[Alert]:\n        """\n        Check process resource usage and generate alerts.\n        \n        Args:\n            processes: List of process information dictionaries\n        \n        Returns:\n            List of generated alerts\n        """\n        new_alerts = []\n        \n        # Check for processes using excessive resources\n        for proc in processes:\n            if proc.get('cpu_percent', 0) > 50:\n                alert = Alert(\n                    alert_type=AlertType.PROCESS_HIGH_USAGE,\n                    severity=AlertSeverity.INFO,\n                    message=f"Process '{proc.get('name', 'Unknown')}' using high CPU: {proc.get('cpu_percent', 0):.1f}%",\n                    metric_value=proc.get('cpu_percent', 0),\n                    threshold=50\n                )\n                new_alerts.append(alert)\n                self._add_alert(alert)\n        \n        return new_alerts\n    \n    def _add_alert(self, alert: Alert) -> None:\n        """Add alert to history and maintain size limit"""\n        self.alerts.insert(0, alert)  # Add to front\n        if len(self.alerts) > self.max_alerts:\n            self.alerts = self.alerts[:self.max_alerts]\n        self.logger.warning(f"Alert generated: {alert.message}")\n    \n    def get_alerts(self, severity: Optional[AlertSeverity] = None, limit: int = 50) -> List[Dict[str, Any]]:\n        """\n        Get recent alerts, optionally filtered by severity.\n        \n        Args:\n            severity: Filter by severity level (optional)\n            limit: Maximum number of alerts to return\n        \n        Returns:\n            List of alert dictionaries\n        """\n        filtered_alerts = self.alerts\n        \n        if severity:\n            filtered_alerts = [a for a in self.alerts if a.severity == severity]\n        \n        return [alert.to_dict() for alert in filtered_alerts[:limit]]\n    \n    def clear_alerts(self) -> None:\n        """Clear all alerts"""\n        self.alerts.clear()\n        self.logger.info("All alerts cleared")\n    \n    def get_alert_summary(self) -> Dict[str, Any]:\n        """\n        Get summary statistics of alerts.\n        \n        Returns:\n            Dictionary with alert counts by severity\n        """\n        summary = {\n            'total': len(self.alerts),\n            'by_severity': {\n                'info': 0,\n                'warning': 0,\n                'critical': 0\n            },\n            'by_type': {}\n        }\n        \n        for alert in self.alerts:\n            # Count by severity\n            summary['by_severity'][alert.severity.value] += 1\n            \n            # Count by type\n            alert_type = alert.alert_type.value\n            summary['by_type'][alert_type] = summary['by_type'].get(alert_type, 0) + 1\n        \n        return summary\n\n\n# Global alert manager instance\nalert_manager = AlertManager()
